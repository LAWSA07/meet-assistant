<!DOCTYPE html>
<html>
<head>
    <title>Extension Connection Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #28a745; color: white; }
        .error { background: #dc3545; color: white; }
        .warning { background: #ffc107; color: black; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🔧 Extension Connection Test</h1>
    
    <div class="test-section">
        <h2>1. HTTP Connection Test</h2>
        <button onclick="testHttpConnection()">Test HTTP Connection</button>
        <div id="httpStatus" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>2. WebSocket Connection Test</h2>
        <button onclick="testWebSocketConnection()">Test WebSocket Connection</button>
        <button onclick="sendTestMessage()">Send Test Message</button>
        <div id="wsStatus" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Extension Test</h2>
        <p>Click the extension icon in your browser toolbar to test the overlay.</p>
        <div id="extensionStatus" class="status warning">Extension status will appear here when you click the extension icon</div>
    </div>
    
    <div class="test-section">
        <h2>4. Console Log</h2>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        let ws = null;
        
        function addLog(message) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `<div>[${time}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testHttpConnection() {
            addLog('Testing HTTP connection to backend...');
            try {
                const response = await fetch('http://127.0.0.1:8001/');
                const data = await response.json();
                addLog(`✅ HTTP connection successful: ${JSON.stringify(data)}`);
                updateStatus('httpStatus', '✅ HTTP Connection: OK', 'success');
            } catch (error) {
                addLog(`❌ HTTP connection failed: ${error.message}`);
                updateStatus('httpStatus', '❌ HTTP Connection: Failed', 'error');
            }
        }
        
        function testWebSocketConnection() {
            addLog('Testing WebSocket connection...');
            try {
                ws = new WebSocket('ws://127.0.0.1:8001/ws/audio');
                
                ws.onopen = function(event) {
                    addLog('✅ WebSocket connection opened');
                    updateStatus('wsStatus', '✅ WebSocket: Connected', 'success');
                };
                
                ws.onmessage = function(event) {
                    addLog(`📥 Received: ${event.data}`);
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'connection_status') {
                            updateStatus('wsStatus', '✅ WebSocket: ' + data.message, 'success');
                        }
                    } catch (e) {
                        addLog(`❌ Error parsing message: ${e}`);
                    }
                };
                
                ws.onerror = function(error) {
                    addLog(`❌ WebSocket error: ${error}`);
                    updateStatus('wsStatus', '❌ WebSocket: Error', 'error');
                };
                
                ws.onclose = function(event) {
                    addLog(`🔌 WebSocket closed: ${event.code} - ${event.reason}`);
                    updateStatus('wsStatus', '🔌 WebSocket: Disconnected', 'error');
                };
                
            } catch (error) {
                addLog(`❌ Failed to create WebSocket: ${error}`);
                updateStatus('wsStatus', '❌ WebSocket: Failed to create', 'error');
            }
        }
        
        function sendTestMessage() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const testMessage = {
                    type: 'test',
                    message: 'Hello from test page!'
                };
                ws.send(JSON.stringify(testMessage));
                addLog('📤 Sent test message');
            } else {
                addLog('❌ WebSocket not connected');
            }
        }
        
        // Listen for messages from the extension
        window.addEventListener('message', (event) => {
            if (event.data.type === 'EXTENSION_STATUS') {
                addLog(`📱 Extension status: ${event.data.message}`);
                updateStatus('extensionStatus', event.data.message, 'success');
            }
        });
        
        // Auto-test on page load
        window.addEventListener('load', function() {
            addLog('🚀 Test page loaded');
            setTimeout(testHttpConnection, 1000);
        });
    </script>
</body>
</html> 